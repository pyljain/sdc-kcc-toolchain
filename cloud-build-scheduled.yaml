steps:
- id: 'Get git credentials'
  name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    echo $_GITHUB_KEY > /root/.ssh/id_github
    chmod 600 /root/.ssh/id_github
    cat <<EOF >/root/.ssh/config
    Hostname github.com
    IdentityFile /root/.ssh/id_github
    EOF
    ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- id: 'Clone repo'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['clone', 'git@github.com:pyljain/sdc-kcc-toolchain.git']
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- id: 'Create new branch'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['checkout', '-b', 'recommendations-$BUILD_ID']
- id: 'Get the number of setters'
  # This step fetches the policies from the repository
  name: 'gcr.io/kpt-dev/kpt:latest'
  entrypoint: '/bin/sh'
  args: ['-c', 'kpt cfg list-setters manifests/']
- id: 'Set namespace in manifests'
  # This step fetches the policies from the repository
  name: 'gcr.io/kpt-dev/kpt:latest'
  entrypoint: '/bin/sh'
  args: ['-c', 'kpt cfg set manifests/ namespace ${_NAMESPACE_NAME} -R']
- id: 'Set projectId in manifests'
  # This step fetches the policies from the repository
  name: 'gcr.io/kpt-dev/kpt:latest'
  entrypoint: '/bin/sh'
  args: ['-c', 'kpt cfg set manifests/ projectid sandbox-jainpayal -R']
- id: 'Run recommender function'
  name: 'gcr.io/kpt-dev/kpt'
  args: ['-c', 'kpt fn run ./manifests/ --fn-path ./kpt']
  entrypoint: '/bin/sh'
- id: 'Configure git email for commit'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['config', '--global', 'user.email', 'recommender@gmail.com']
- id: 'Configure git name for commit'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['config', '--global', 'user.name', 'Active Assist']
- id: 'Commit changes to branch'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['commit', '-am', 'Added recommendations']

- id: 'Push branch to remote'
  # This step fetches the policies from the repository
  name: 'gcr.io/cloud-builders/git'
  args: ['push', 'origin', 'recommendations-$BUILD_ID']
  volumes:
  - name: 'ssh'
    path: /root/.ssh
# - id: 'Validate against policies'
  # This step validates resources against recommendations - do the docker way
  # name: 'gcr.io/kpt-dev/kpt'
  # args: ['-c', 'kpt fn run ../manifests/ --enable-exec --exec-path ./activeassist_run-macos']
# - id: "Run functions"
#   name: 'gcr.io/kpt-dev/kpt:latest'
#   args:
#     - fn
#     - run
    # - exmaple-package